<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>MemoApp</title>
	<!-- Bootstrap導入 -->
	<link href="css/bootstrap.min.css" rel="stylesheet">
	<!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="js/bootstrap.min.js"></script>   -->

	<!-- 別ファイルの呼び出し -->
	<link href="style.css" rel="stylesheet">
	<script src = "./public_js/AddMemu.js"></script>
	<script src = "./public_js/ShowTag.js"></script>  
</head>
<body>
	
	<div id="main" class = "pege">
		<ul id="addTag" class="nav nav-tabs nav-justified">
			<a id="Tag" href="#" class="nav-link" onclick="showMainTag()">全てのメモ</a>
		</ul>
	
		<div id="showInputMemo" class="d-none">
			<div class = "fontColor">
				<h3>タグの追加</h3>
					新しいタグの追加・削除<br />
					<input type="text" id="tag" /> 
					<input type="button" value="new" onclick="addTage()"/> <!--addMemu.jsへ-->
					<input type="button" value="delete" onclick="deleteTag()"/> <!--addMemu.jsへ-->
				<hr />

				<h3>登録・更新</h3>
					件名<input type="text" id="newkey" /> 
					<br>
					本文
					<form action="#">
						<textarea id="newvalue" name="本文" rows="3" cols="50" wrap="hard"></textarea>
					</form>
					<input type="button" value="設定" onclick="setValue()"/>
				<hr />
				
				<!--
				<h3>参照</h3>
					取得したい値のキー<input type="text" id="selectkey" />
					<input type="button" value="取得" onclick="getValue()"/>
					<input type="button" value="全取得" onclick="getAll()"/>
					<input type="button" value="件数表示" onclick="getCount()"/>
				<hr />

				-->
				
				<h3>削除</h3>
					削除したい値のキー<input type="text" id="deletekey" />
					<input type="button" value="削除" onclick="deleteValue()"/>
					<input type="button" value="全削除" onclick="deleteAll()"/>
				<hr />

				
				<h3>処理結果</h3>
					<div id="result">
						<br>
						<br>
					</div>
		</div>

		<!--
		<h3>インデックスを使った検索</h3>
		<input type="text" id="selectValue1" />～<input type="text" id="selectValue2" />
		<input type="button" value="検索" onclick="getKey()"/>
		<hr />
		-->
		
		<div id="mainTag">
			<div id="addDetails">
				<!--<details>
					<summary>test1</summary>
						<p>test2</p>
				</details> -->
			</div>	
		</div>

	</div>
	
		
	
		
</body>

<script>
	var db;
	var indexedDB = window.indexedDB || window.mozIndexedDB || window.msIndexedDB;

	let mainTag = document.getElementById("mainTag");  //のID取得
	let inputMemoVar = document.getElementById("showInputMemo");  //のID取得

	if (indexedDB) {
		// データベースを削除したい場合はコメントを外します。
		//indexedDB.deleteDatabase("mydb");
		var openRequest = indexedDB.open("mydb", 1.0);
		//データベース名を指定して接続。なければ新規作成される
		
		
		openRequest.onupgradeneeded = function(event) {
			// データベースのバージョンに変更があった場合(初めての場合もここを通ります。)
			db = event.target.result;
			console.log("OK");
			//メモ内容の保存ストア
			var store = db.createObjectStore("mystore", { keyPath: "mykey"});
			store.createIndex("myvalueIndex", "myvalue");
			

			//タグリストの保存ストア
			
			var tagStore = db.createObjectStore("tagstore", { keyPath: "tagKey"});
			tagStore.createIndex("tagValueIndex", "tagvalue");
		}
		
		openRequest.onsuccess = function(event) {
	        db = event.target.result;
			//mainTag.classList.remove("d-none");
			inputMemoVar.classList.remove("d-none");
			Onload();
			getAll();
        }
	} else {
		window.alert("このブラウザではIndexed DataBase API は使えません。");
	}


	

	
	function setValue(event) {
		var key = document.getElementById("newkey").value;
		var value = document.getElementById("newvalue").value;
        //件名と本文の取得
		
		var transaction = db.transaction(["mystore"], "readwrite");
		var store = transaction.objectStore("mystore");

		let keyFlag = store.get(key);  //入力したKEYがすでにある場合
		keyFlag.onsuccess = function (event) {
			if (event.target.result !== undefined) {
				let target = document.getElementById(key);  //入力した内容がIDになっている
				target.remove();
			}
		}
		
		showMemo({summary:key, detail:value, tabNum:null});
		
		var request = store.put({ mykey: key, myvalue: value});
		request.onsuccess = function (event) {
			document.getElementById("newkey").value = "";
			document.getElementById("newvalue").value = "";
		}
	}
	
	function getValue(event) {  //件名を検索して本文表示
		var key = document.getElementById("selectkey").value;
		var result = document.getElementById("result");
		result.innerHTML = "";
		
		var transaction = db.transaction(["mystore"], "readwrite");
		var store = transaction.objectStore("mystore");
		
		var request = store.get(key);
		request.onsuccess = function (event) {
		
			if (event.target.result === undefined) {
				result.innerHTML = "指定したキーは存在しません。";
			} else {
				var MailText = "";

				for (let i = 0; i < 1000; i++) {  //本文の上限の1000文字まで繰り返す
					if(event.target.result.myvalue.slice(i,i+1) === undefined) {
						//本文を読み込みきった場合はループから出る。
						break;
					}
					if(event.target.result.myvalue.slice(i,i+1) === "\n") {
						//改行があった場合
						MailText = MailText + "<br/>";
					}else {
						MailText = MailText + event.target.result.myvalue.slice(i,i+1);
					}
				}

				result.innerHTML = MailText + "<br/>";
			}
		}
	}
	
	function getAll(event) {
	
		var result = document.getElementById("result");
		result.innerHTML = "";
		
		var transaction = db.transaction(["mystore"], "readwrite");
		var store = transaction.objectStore("mystore");
		var request = store.openCursor();
		
		request.onsuccess = function (event) {
		
			if(event.target.result == null) {
				return;
			}
			
			var cursor = event.target.result;
	        var data = cursor.value;
			showMemo({summary:cursor.key, detail:data.myvalue, tabNum:null});
			//result.innerHTML += "key："  + cursor.key +  "  value：" + data.myvalue + "<br/>";
			
			cursor.continue();
		}
	}
	
	function getCount(event) {
	
		var result = document.getElementById("result");
		result.innerHTML = "";
		
		var transaction = db.transaction(["mystore"], "readwrite");
		var store = transaction.objectStore("mystore");
		var request = store.count();
		
		request.onsuccess = function (event) {
			result.innerHTML = event.target.result + "件";
		}
	}
	
	function deleteValue(event) {
		var key = document.getElementById("deletekey").value;
		var result = document.getElementById("result");
		result.innerHTML = "";
		
		var transaction = db.transaction(["mystore"], "readwrite");
		var store = transaction.objectStore("mystore");
		
		var request = store.delete(key);
		request.onsuccess = function (event) {
			result.innerHTML = "削除しました。";
		}
	}
	
	function deleteAll(event) {
	
		var result = document.getElementById("result");
		result.innerHTML = "";
		
		var transaction = db.transaction(["mystore"], "readwrite");
		var store = transaction.objectStore("mystore");
		var request = store.clear();
		
		request.onsuccess = function (event) {
			result.innerHTML = "クリアしました。";
		}
	}
	
	function getKey(event) {
	
		var value1 = document.getElementById("selectValue1").value;
		var value2 = document.getElementById("selectValue2").value;
		
		var result = document.getElementById("result");
		result.innerHTML = "";
		
		var transaction = db.transaction(["mystore"], "readwrite");
		var store = transaction.objectStore("mystore");
		var index = store.index("myvalueIndex");
		
		var range = IDBKeyRange.bound(value1, value2);
		var request = index.openCursor(range);
		
		request.onsuccess = function (event) {
		
			if(event.target.result == null) {
				return;
			}
			
			var cursor = event.target.result;
	        var data = cursor.value;
			result.innerHTML += "value：" + data.myvalue + "  key："  + data.mykey + "<br/>";
			
			cursor.continue();
		}
	}

</script>
</html>